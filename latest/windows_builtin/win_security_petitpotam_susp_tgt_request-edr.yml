detect:
  event: WEL
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - case sensitive: false
        op: is
        path: event/EVENT/System/EventID
        value: '4768'
      - case sensitive: false
        op: ends with
        path: event/EVENT/EventData/TargetUserName
        value: $
      - op: exists
        path: event/EVENT/EventData/CertThumbprint
    - not: true
      op: or
      rules:
      - case sensitive: false
        op: is
        path: event/EVENT/EventData/IpAddress
        value: ::1
      - case sensitive: false
        op: is
        path: event/EVENT/EventData/CertThumbprint
        value: ''
respond:
- action: report
  metadata:
    author: Mauricio Velazco, Michael Haag
    description: 'Detect suspicious Kerberos TGT requests.

      Once an attacer obtains a computer certificate by abusing Active Directory Certificate
      Services in combination with PetitPotam, the next step would be to leverage
      the certificate for malicious purposes.

      One way of doing this is to request a Kerberos Ticket Granting Ticket using
      a tool like Rubeus.

      This request will generate a 4768 event with some unusual fields depending on
      the environment.

      This analytic will require tuning, we recommend filtering Account_Name to the
      Domain Controller computer accounts.

      '
    falsepositives:
    - False positives are possible if the environment is using certificates for authentication.
      We recommend filtering Account_Name to the Domain Controller computer accounts.
    level: high
    references:
    - https://github.com/topotam/PetitPotam
    - https://isc.sans.edu/forums/diary/Active+Directory+Certificate+Services+ADCS+PKI+domain+admin+vulnerability/27668/
    - https://github.com/splunk/security_content/blob/88d689fe8a055d8284337b9fad5d9152b42043db/detections/endpoint/petitpotam_suspicious_kerberos_tgt_request.yml
    tags:
    - attack.credential-access
    - attack.t1187
  name: PetitPotam Suspicious Kerberos TGT Request

