detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: reg
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: add
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: d 4
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: v Start
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \AppIDSvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \MsMpSvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \NisSrv
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \SecurityHealthService
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Sense
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \UsoSvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \WdBoot
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \WdFilter
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \WdNisDrv
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \WdNisSvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \WinDefend
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \wscsvc
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \wuauserv
respond:
- action: report
  metadata:
    author: Florian Roth (Nextron Systems), John Lambert (idea), elhoim
    description: Detects execution of "reg.exe" to disable security services such
      as Windows Defender.
    falsepositives:
    - Unlikely
    level: high
    references:
    - https://twitter.com/JohnLaTwC/status/1415295021041979392
    - https://github.com/gordonbay/Windows-On-Reins/blob/e587ac7a0407847865926d575e3c46f68cf7c68d/wor.ps1
    - https://vms.drweb.fr/virus/?i=24144899
    - https://bidouillesecurity.com/disable-windows-defender-in-powershell/
    tags:
    - attack.defense-evasion
    - attack.t1562.001
  name: Security Service Disabled Via Reg.EXE

