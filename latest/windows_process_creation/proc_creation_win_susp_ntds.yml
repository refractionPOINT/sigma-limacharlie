detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - op: or
      rules:
      - op: or
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \NTDSDump.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \NTDSDumpEx.exe
        - op: and
          rules:
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: ntds.dit
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: system.hiv
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: NTDSgrab.ps1
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ac i ntds
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: create full
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: '/c copy '
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \windows\ntds\ntds.dit
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: activate instance ntds
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: create full
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: powershell
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ntds.dit
    - op: and
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ntds.dit
      - op: or
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \apache
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \tomcat
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \AppData\
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \Temp\
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \Public\
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \PerfLogs\
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \apache
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \tomcat
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \AppData\
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \Temp\
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \Public\
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \PerfLogs\
respond:
- action: report
  metadata:
    author: Florian Roth (Nextron Systems)
    description: Detects suspicious process patterns used in NTDS.DIT exfiltration
    falsepositives:
    - Unknown
    level: high
    references:
    - https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration
    - https://www.n00py.io/2022/03/manipulating-user-passwords-without-mimikatz/
    - https://pentestlab.blog/tag/ntds-dit/
    - https://github.com/samratashok/nishang/blob/414ee1104526d7057f9adaeee196d91ae447283e/Gather/Copy-VSS.ps1
    - https://github.com/zcgonvh/NTDSDumpEx
    - https://github.com/rapid7/metasploit-framework/blob/d297adcebb5c1df6fe30b12ca79b161deb71571c/data/post/powershell/NTDSgrab.ps1
    - https://blog.talosintelligence.com/2022/08/recent-cyber-attack.html?m=1
    tags:
    - attack.credential-access
    - attack.t1003.003
  name: Suspicious Process Patterns NTDS.DIT Exfil

