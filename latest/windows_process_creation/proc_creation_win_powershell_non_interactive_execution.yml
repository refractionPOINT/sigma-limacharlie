detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - op: or
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \powershell.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \pwsh.exe
        - op: or
          rules:
          - case sensitive: false
            op: is
            path: event/ORIGINAL_FILE_NAME
            value: PowerShell.EXE
          - case sensitive: false
            op: is
            path: event/ORIGINAL_FILE_NAME
            value: pwsh.dll
      - not: true
        op: or
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/PARENT/FILE_PATH
            value: :\Windows\explorer.exe
          - case sensitive: false
            op: ends with
            path: event/PARENT/FILE_PATH
            value: :\Windows\System32\CompatTelRunner.exe
          - case sensitive: false
            op: ends with
            path: event/PARENT/FILE_PATH
            value: :\Windows\SysWOW64\explorer.exe
        - case sensitive: false
          op: is
          path: event/PARENT/FILE_PATH
          value: :\$WINDOWS.~BT\Sources\SetupHost.exe
    - not: true
      op: or
      rules:
      - op: and
        rules:
        - case sensitive: false
          op: ends with
          path: event/PARENT/FILE_PATH
          value: \AppData\Local\Programs\Microsoft VS Code\Code.exe
        - case sensitive: false
          op: contains
          path: event/PARENT/COMMAND_LINE
          value: ' --ms-enable-electron-run-as-node '
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/PARENT/FILE_PATH
          value: :\Program Files\WindowsApps\Microsoft.WindowsTerminal_
        - case sensitive: false
          op: ends with
          path: event/PARENT/FILE_PATH
          value: \WindowsTerminal.exe
respond:
- action: report
  metadata:
    author: Roberto Rodriguez @Cyb3rWard0g (rule), oscd.community (improvements)
    description: Detects non-interactive PowerShell activity by looking at the "powershell"
      process with a non-user GUI process such as "explorer.exe" as a parent.
    falsepositives:
    - Likely. Many admin scripts and tools leverage PowerShell in their BAT or VB
      scripts which may trigger this rule often. It is best to add additional filters
      or use this to hunt for anomalies
    level: low
    references:
    - https://web.archive.org/web/20200925032237/https://threathunterplaybook.com/notebooks/windows/02_execution/WIN-190410151110.html
    tags:
    - attack.execution
    - attack.t1059.001
  name: Non Interactive PowerShell Process Spawned

