detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \svchost.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \taskhost.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \lsm.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \lsass.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \services.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \lsaiso.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \csrss.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \wininit.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \winlogon.exe
    - not: true
      op: or
      rules:
      - op: or
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/PARENT/FILE_PATH
            value: \SavService.exe
          - case sensitive: false
            op: ends with
            path: event/PARENT/FILE_PATH
            value: \ngen.exe
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \System32\
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \SysWOW64\
      - op: and
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \Windows Defender\
          - case sensitive: false
            op: contains
            path: event/PARENT/FILE_PATH
            value: \Microsoft Security Client\
        - case sensitive: false
          op: ends with
          path: event/PARENT/FILE_PATH
          value: \MsMpEng.exe
      - op: or
        rules:
        - not: true
          op: exists
          path: event/PARENT/FILE_PATH
        - op: or
          rules:
          - case sensitive: false
            op: is
            path: event/PARENT/FILE_PATH
            value: ''
          - case sensitive: false
            op: is
            path: event/PARENT/FILE_PATH
            value: '-'
respond:
- action: report
  metadata:
    author: vburov
    description: Detect suspicious parent processes of well-known Windows processes
    falsepositives:
    - Some security products seem to spawn these
    level: low
    references:
    - https://web.archive.org/web/20180718061628/https://securitybytes.io/blue-team-fundamentals-part-two-windows-processes-759fe15965e2
    - https://www.carbonblack.com/2014/06/10/screenshot-demo-hunt-evil-faster-than-ever-with-carbon-black/
    - https://www.13cubed.com/downloads/windows_process_genealogy_v2.pdf
    tags:
    - attack.defense-evasion
    - attack.t1036.003
    - attack.t1036.005
  name: Windows Processes Suspicious Parent Directory

