detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/PARENT/FILE_PATH
        value: \appvlp.exe
      - not: true
        op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: :\Windows\SysWOW64\rundll32.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: :\Windows\System32\rundll32.exe
    - not: true
      op: or
      rules:
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: :\Program Files\Microsoft Office
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \msoasb.exe
      - op: and
        rules:
        - op: and
          rules:
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: :\Program Files\Microsoft Office
          - case sensitive: false
            op: contains
            path: event/FILE_PATH
            value: \SkypeSrv\
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \SKYPESERVER.EXE
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: :\Program Files\Microsoft Office
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \MSOUC.EXE
respond:
- action: report
  metadata:
    author: Sreeman
    description: 'Detects uncommon child processes of Appvlp.EXE

      Appvlp or the Application Virtualization Utility is included with Microsoft
      Office. Attackers are able to abuse "AppVLP" to execute shell commands.

      Normally, this binary is used for Application Virtualization, but it can also
      be abused to circumvent the ASR file path rule folder

      or to mark a file as a system file.

      '
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://lolbas-project.github.io/lolbas/OtherMSBinaries/Appvlp/
    tags:
    - attack.t1218
    - attack.defense_evasion
    - attack.execution
  name: Uncommon Child Process Of Appvlp.EXE

