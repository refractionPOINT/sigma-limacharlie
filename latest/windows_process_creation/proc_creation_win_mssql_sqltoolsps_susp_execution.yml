detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \sqltoolsps.exe
      - case sensitive: false
        op: ends with
        path: event/PARENT/FILE_PATH
        value: \sqltoolsps.exe
      - case sensitive: false
        op: is
        path: event/ORIGINAL_FILE_NAME
        value: \sqltoolsps.exe
    - case sensitive: false
      not: true
      op: ends with
      path: event/PARENT/FILE_PATH
      value: \smss.exe
respond:
- action: report
  metadata:
    author: Agro (@agro_sev) oscd.communitly
    description: 'This rule detects execution of a PowerShell code through the sqltoolsps.exe
      utility, which is included in the standard set of utilities supplied with the
      Microsoft SQL Server Management studio.

      Script blocks are not logged in this case, so this utility helps to bypass protection
      mechanisms based on the analysis of these logs.

      '
    falsepositives:
    - Direct PS command execution through SQLToolsPS.exe is uncommon, childprocess
      sqltoolsps.exe spawned by smss.exe is a legitimate action.
    level: medium
    references:
    - https://github.com/LOLBAS-Project/LOLBAS/blob/8283d8d91552213ded165fd36deb6cb9534cb443/yml/OtherMSBinaries/Sqltoolsps.yml
    - https://twitter.com/pabraeken/status/993298228840992768
    tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense-evasion
    - attack.t1127
  name: SQL Client Tools PowerShell Session Detection

