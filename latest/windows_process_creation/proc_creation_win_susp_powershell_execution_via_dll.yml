detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \InstallUtil.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \RegAsm.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \RegSvcs.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \regsvr32.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \rundll32.exe
      - op: or
        rules:
        - case sensitive: false
          op: is
          path: event/ORIGINAL_FILE_NAME
          value: InstallUtil.exe
        - case sensitive: false
          op: is
          path: event/ORIGINAL_FILE_NAME
          value: RegAsm.exe
        - case sensitive: false
          op: is
          path: event/ORIGINAL_FILE_NAME
          value: RegSvcs.exe
        - case sensitive: false
          op: is
          path: event/ORIGINAL_FILE_NAME
          value: REGSVR32.EXE
        - case sensitive: false
          op: is
          path: event/ORIGINAL_FILE_NAME
          value: RUNDLL32.EXE
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Default.GetString
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: DownloadString
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: FromBase64String
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: 'ICM '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: 'IEX '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Invoke-Command
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: Invoke-Expression
respond:
- action: report
  metadata:
    author: Markus Neis, Nasreddine Bencherchali (Nextron Systems)
    description: 'Detects potential PowerShell execution from a DLL instead of the
      usual PowerShell process as seen used in PowerShdll.

      This detection assumes that PowerShell commands are passed via the CommandLine.

      '
    falsepositives:
    - Unknown
    level: high
    references:
    - https://github.com/p3nt4/PowerShdll/blob/62cfa172fb4e1f7f4ac00ca942685baeb88ff356/README.md
    tags:
    - attack.defense_evasion
    - attack.t1218.011
  name: Potential PowerShell Execution Via DLL

