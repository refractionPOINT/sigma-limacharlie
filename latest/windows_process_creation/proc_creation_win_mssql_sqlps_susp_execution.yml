detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - case sensitive: false
      op: ends with
      path: event/PARENT/FILE_PATH
      value: \sqlps.exe
    - op: and
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \sqlps.exe
        - case sensitive: false
          op: is
          path: event/ORIGINAL_FILE_NAME
          value: sqlps.exe
      - case sensitive: false
        not: true
        op: ends with
        path: event/PARENT/FILE_PATH
        value: \sqlagent.exe
respond:
- action: report
  metadata:
    author: Agro (@agro_sev) oscd.community
    description: 'This rule detects execution of a PowerShell code through the sqlps.exe
      utility, which is included in the standard set of utilities supplied with the
      MSSQL Server.

      Script blocks are not logged in this case, so this utility helps to bypass protection
      mechanisms based on the analysis of these logs.

      '
    falsepositives:
    - Direct PS command execution through SQLPS.exe is uncommon, childprocess sqlps.exe
      spawned by sqlagent.exe is a legitimate action.
    level: medium
    references:
    - https://learn.microsoft.com/en-us/sql/tools/sqlps-utility?view=sql-server-ver15
    - https://lolbas-project.github.io/lolbas/OtherMSBinaries/Sqlps/
    - https://twitter.com/bryon_/status/975835709587075072
    tags:
    - attack.execution
    - attack.t1059.001
    - attack.defense-evasion
    - attack.t1127
  name: Detection of PowerShell Execution via Sqlps.exe

