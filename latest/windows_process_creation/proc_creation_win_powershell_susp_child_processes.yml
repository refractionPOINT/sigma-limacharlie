detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/PARENT/FILE_PATH
          value: \powershell_ise.exe
        - case sensitive: false
          op: ends with
          path: event/PARENT/FILE_PATH
          value: \powershell.exe
        - case sensitive: false
          op: ends with
          path: event/PARENT/FILE_PATH
          value: \pwsh.exe
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \bash.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \bitsadmin.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \certutil.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \cscript.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \forfiles.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \hh.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \mshta.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \regsvr32.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \rundll32.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \schtasks.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \scrcons.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \scriptrunner.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \sh.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wmic.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wscript.exe
    - not: true
      op: and
      rules:
      - case sensitive: false
        op: contains
        path: event/PARENT/COMMAND_LINE
        value: \Program Files\Amazon\WorkspacesConfig\Scripts\
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Program Files\Amazon\WorkspacesConfig\Scripts\
respond:
- action: report
  metadata:
    author: Florian Roth (Nextron Systems), Tim Shelton
    description: Detects potentially suspicious child processes spawned by PowerShell
    falsepositives:
    - Some false positive is to be expected from PowerShell scripts that might make
      use of additional binaries such as "mshta", "bitsadmin", etc. Apply additional
      filters for those scripts when needed.
    level: high
    references:
    - https://twitter.com/ankit_anubhav/status/1518835408502620162
    tags:
    - attack.execution
    - attack.t1059.001
  name: Potentially Suspicious PowerShell Child Processes

