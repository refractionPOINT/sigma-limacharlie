detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \runonce.exe
    - case sensitive: false
      op: ends with
      path: event/PARENT/FILE_PATH
      value: \rundll32.exe
    - case sensitive: false
      op: contains
      path: event/PARENT/COMMAND_LINE
      value: setupapi.dll
    - case sensitive: false
      op: contains
      path: event/PARENT/COMMAND_LINE
      value: InstallHinfSection
respond:
- action: report
  metadata:
    author: Konstantin Grishchenko, oscd.community
    description: setupapi.dll library provide InstallHinfSection function for processing
      INF files. INF file may contain instructions allowing to create values in the
      registry, modify files and install drivers. This technique could be used to
      obtain persistence via modifying one of Run or RunOnce registry keys, run process
      or use other DLLs chain calls (see references) InstallHinfSection function in
      setupapi.dll calls runonce.exe executable regardless of actual content of INF
      file.
    falsepositives:
    - Scripts and administrative tools that use INF files for driver installation
      with setupapi.dll
    level: medium
    references:
    - https://lolbas-project.github.io/lolbas/Libraries/Setupapi/
    - https://gist.githubusercontent.com/bohops/0cc6586f205f3691e04a1ebf1806aabd/raw/baf7b29891bb91e76198e30889fbf7d6642e8974/calc_exe.inf
    - https://raw.githubusercontent.com/huntresslabs/evading-autoruns/master/shady.inf
    - https://twitter.com/Z3Jpa29z/status/1313742350292746241?s=20
    tags:
    - attack.defense-evasion
    - attack.t1218.011
  name: Suspicious Rundll32 Setupapi.dll Activity

