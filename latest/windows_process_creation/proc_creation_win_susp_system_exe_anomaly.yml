detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \atbroker.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \audiodg.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \bcdedit.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \bitsadmin.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \certreq.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \certutil.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \cmstp.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \conhost.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \consent.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \cscript.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \csrss.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \dashost.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \defrag.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \dfrgui.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \dism.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \dllhost.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \dllhst3g.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \dwm.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \eventvwr.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \logonui.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \LsaIso.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \lsass.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \lsm.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \msiexec.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \ntoskrnl.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \powershell_ise.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \powershell.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \pwsh.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \regsvr32.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \rundll32.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \runonce.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \RuntimeBroker.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \schtasks.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \services.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \sihost.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \smartscreen.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \smss.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \spoolsv.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \svchost.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \taskhost.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \Taskmgr.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \userinit.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wininit.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \winlogon.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \winver.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wlanext.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wscript.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wsl.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \wsmprovhost.exe
      - not: true
        op: or
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\\$WINDOWS\.\~BT\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\\$WinREAgent\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Windows\\SoftwareDistribution\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Windows\\System32\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Windows\\SystemTemp\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Windows\\SysWOW64\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Windows\\uus\\
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Windows\\WinSxS\\
        - op: or
          rules:
          - case sensitive: false
            op: is
            path: event/FILE_PATH
            value: C:\Program Files\PowerShell\7\pwsh.exe
          - case sensitive: false
            op: is
            path: event/FILE_PATH
            value: C:\Program Files\PowerShell\7-preview\pwsh.exe
        - op: and
          rules:
          - case sensitive: false
            op: matches
            path: event/FILE_PATH
            re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\Program\ Files\\WindowsApps\\MicrosoftCorporationII\.WindowsSubsystemForLinux
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \wsl.exe
    - case sensitive: false
      not: true
      op: contains
      path: event/FILE_PATH
      value: \SystemRoot\System32\
respond:
- action: report
  metadata:
    author: Florian Roth (Nextron Systems), Patrick Bareiss, Anton Kutepov, oscd.community,
      Nasreddine Bencherchali (Nextron Systems)
    description: 'Detects the execution of a Windows system binary that is usually
      located in the system folder from an uncommon location.

      '
    falsepositives:
    - Unknown
    level: high
    references:
    - https://twitter.com/GelosSnake/status/934900723426439170
    - https://asec.ahnlab.com/en/39828/
    tags:
    - attack.defense-evasion
    - attack.t1036
  name: System File Execution Location Anomaly

