detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - op: or
      rules:
      - op: and
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \wevtutil.exe
          - case sensitive: false
            op: is
            path: event/ORIGINAL_FILE_NAME
            value: wevtutil.exe
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'clear-log '
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: ' cl '
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'set-log '
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: ' sl '
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'lfn:'
      - op: and
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \powershell.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \powershell_ise.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \pwsh.exe
        - op: or
          rules:
          - op: or
            rules:
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: 'Clear-EventLog '
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: 'Remove-EventLog '
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: 'Limit-EventLog '
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: 'Clear-WinEvent '
          - op: and
            rules:
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: Eventing.Reader.EventLogSession
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: ClearLog
          - op: and
            rules:
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: Diagnostics.EventLog
            - case sensitive: false
              op: contains
              path: event/COMMAND_LINE
              value: Clear
    - op: and
      rules:
      - op: and
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \powershell.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \powershell_ise.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \pwsh.exe
          - case sensitive: false
            op: ends with
            path: event/FILE_PATH
            value: \wmic.exe
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ClearEventLog
      - not: true
        op: and
        rules:
        - op: or
          rules:
          - case sensitive: false
            op: is
            path: event/PARENT/FILE_PATH
            value: C:\Windows\SysWOW64\msiexec.exe
          - case sensitive: false
            op: is
            path: event/PARENT/FILE_PATH
            value: C:\Windows\System32\msiexec.exe
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' sl '
respond:
- action: report
  metadata:
    author: Ecco, Daniil Yugoslavskiy, oscd.community, D3F7A5105, Swachchhanda Shrawan
      Poudel (Nextron Systems)
    description: 'Detects the clearing or configuration tampering of EventLog using
      utilities such as "wevtutil", "powershell" and "wmic".

      This technique were seen used by threat actors and ransomware strains in order
      to evade defenses.

      '
    falsepositives:
    - Admin activity
    - Scripts and administrative tools used in the monitored environment
    - Maintenance activity
    level: high
    references:
    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.001/T1070.001.md
    - https://eqllib.readthedocs.io/en/latest/analytics/5b223758-07d6-4100-9e11-238cfdd0fe97.html
    - https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil
    - https://gist.github.com/fovtran/ac0624983c7722e80a8f5a4babb170ee
    - https://jdhnet.wordpress.com/2017/12/19/changing-the-location-of-the-windows-event-logs/
    - https://www.linkedin.com/posts/huntress-labs_when-a-sketchy-incident-hits-your-network-activity-7304940371078238208-Th_l/?utm_source=share&utm_medium=member_desktop&rcm=ACoAAAJTlRcB28IaUtg03HUU-IdliwzoAL1flGc
    - https://stackoverflow.com/questions/66011412/how-to-clear-a-event-log-in-powershell-7
    - https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventing.reader.eventlogsession.clearlog?view=windowsdesktop-9.0&viewFallbackFrom=dotnet-plat-ext-5.0#System_Diagnostics_Eventing_Reader_EventLogSession_ClearLog_System_String_
    - https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventlog.clear
    tags:
    - attack.defense-evasion
    - attack.t1070.001
    - attack.t1562.002
    - car.2016-04-002
  name: Suspicious Eventlog Clearing or Configuration Change Activity

