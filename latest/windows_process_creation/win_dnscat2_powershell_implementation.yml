detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - case sensitive: false
      op: ends with
      path: event/PARENT/FILE_PATH
      value: \powershell.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \nslookup.exe
    - case sensitive: false
      op: ends with
      path: event/COMMAND_LINE
      value: \nslookup.exe
respond:
- action: report
  metadata:
    author: Cian Heasley
    description: The PowerShell implementation of DNSCat2 calls nslookup to craft
      queries. Counting nslookup processes spawned by PowerShell will show hundreds
      or thousands of instances if PS DNSCat2 is active locally.
    falsepositives:
    - Other powershell scripts that call nslookup.exe
    level: high
    references:
    - https://github.com/lukebaggett/dnscat2-powershell
    - https://blu3-team.blogspot.com/2019/08/powershell-dns-c2-notes.html
    - https://ragged-lab.blogspot.com/2020/06/it-is-always-dns-powershell-edition.html
    tags:
    - attack.command_and_control
    - attack.t1071
    - attack.t1071.004
    - attack.t1001.003
    - attack.t1041
  name: DNSCat2 Powershell Implementation Detection Via Process Creation

