detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \netsh.exe
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: firewall
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: add
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: allowedprogram
        - op: and
          rules:
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: advfirewall
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: rule
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: action=allow
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: program=
    - op: or
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: '%TEMP%'
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: :\RECYCLER\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: C:\$Recycle.bin\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: :\SystemVolumeInformation\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: C:\Windows\Temp\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: C:\Temp\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: C:\Users\Public\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: C:\Users\Default\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: C:\Users\Desktop\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \Downloads\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \Temporary Internet Files\Content.Outlook\
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: \Local Settings\Temporary Internet Files\
      - op: or
        rules:
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\Tasks\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\debug\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\fonts\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\help\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\drivers\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\addins\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\cursors\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: C:\Windows\system32\tasks\
        - case sensitive: false
          op: starts with
          path: event/COMMAND_LINE
          value: '%Public%\'
respond:
- action: report
  metadata:
    author: Sander Wiebing, Jonhnathan Ribeiro, Daniil Yugoslavskiy, oscd.community
    description: Detects Netsh commands that allows a suspcious application location
      on Windows Firewall
    falsepositives:
    - Legitimate administration
    level: high
    references:
    - https://www.virusradar.com/en/Win32_Kasidet.AD/description
    - https://www.hybrid-analysis.com/sample/07e789f4f2f3259e7559fdccb36e96814c2dbff872a21e1fa03de9ee377d581f?environmentId=100
    tags:
    - attack.defense_evasion
    - attack.t1562.004
  name: Netsh Program Allowed with Suspcious Location

