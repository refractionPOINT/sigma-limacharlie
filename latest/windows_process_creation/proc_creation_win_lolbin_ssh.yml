detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - case sensitive: false
      op: is
      path: event/PARENT/FILE_PATH
      value: C:\Windows\System32\OpenSSH\sshd.exe
    - op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \ssh.exe
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ProxyCommand=
        - op: and
          rules:
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: PermitLocalCommand
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: LocalCommand
respond:
- action: report
  metadata:
    author: frack113, Nasreddine Bencherchali
    description: Detect usage of the "ssh.exe" binary as a proxy to launch other programs
    falsepositives:
    - Legitimate usage for administration purposes
    level: medium
    references:
    - https://lolbas-project.github.io/lolbas/Binaries/Ssh/
    - https://github.com/LOLBAS-Project/LOLBAS/pull/211/files
    - https://gtfobins.github.io/gtfobins/ssh/
    - https://man.openbsd.org/ssh_config#ProxyCommand
    - https://man.openbsd.org/ssh_config#LocalCommand
    tags:
    - attack.defense_evasion
    - attack.t1202
  name: Lolbin Ssh.exe Use As Proxy

