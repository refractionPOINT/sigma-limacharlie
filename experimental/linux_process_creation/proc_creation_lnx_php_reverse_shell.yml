detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is linux
  - op: and
    rules:
    - case sensitive: true
      op: contains
      path: event/FILE_PATH
      value: /php
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: ' -r '
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: fsockopen
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ash
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: bash
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: bsh
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: csh
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ksh
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: pdksh
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: sh
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: tcsh
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: zsh
respond:
- action: report
  metadata:
    author: '@d4ns4n_'
    description: 'Detects usage of the PHP CLI with the "-r" flag which allows it
      to run inline PHP code. The rule looks for calls to the "fsockopen" function
      which allows the creation of sockets.

      Attackers often leverage this in combination with functions such as "exec" or
      "fopen" to initiate a reverse shell connection.

      '
    falsepositives:
    - Unknown
    level: high
    references:
    - https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet
    - https://www.revshells.com/
    tags:
    - attack.execution
  name: Potential PHP Reverse Shell

