detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is linux
  - op: and
    rules:
    - case sensitive: true
      op: ends with
      path: event/FILE_PATH
      value: /esxcli
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: storage
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' get'
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' list'
respond:
- action: report
  metadata:
    author: Nasreddine Bencherchali (Nextron Systems), Cedric Maurugeon
    description: Detects execution of the "esxcli" command with the "storage" flag
      in order to retrieve information about the storage status and other related
      information. Seen used by malware such as DarkSide and LockBit.
    falsepositives:
    - Legitimate administration activities
    level: medium
    references:
    - https://www.trendmicro.com/en_us/research/21/e/darkside-linux-vms-targeted.html
    - https://www.trendmicro.com/en_us/research/22/a/analysis-and-Impact-of-lockbit-ransomwares-first-linux-and-vmware-esxi-variant.html
    - https://developer.broadcom.com/xapis/esxcli-command-reference/7.0.0/namespace/esxcli_storage.html
    tags:
    - attack.discovery
    - attack.execution
    - attack.t1033
    - attack.t1007
    - attack.t1059.012
  name: ESXi Storage Information Discovery Via ESXCLI

