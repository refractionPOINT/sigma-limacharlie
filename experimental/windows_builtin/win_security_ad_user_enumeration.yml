detect:
  log type: wel
  op: and
  rules:
  - op: and
    rules:
    - case sensitive: false
      op: is
      path: Event/System/EventID
      value: '4662'
    - case sensitive: false
      op: contains
      path: Event/EventData/ObjectType
      value: bf967aba-0de6-11d0-a285-00aa003049e2
  - not: true
    op: or
    rules:
    - case sensitive: false
      op: ends with
      path: Event/EventData/SubjectUserName
      value: $
    - case sensitive: false
      op: starts with
      path: Event/EventData/SubjectUserName
      value: MSOL_
  target: log
respond:
- action: report
  metadata:
    author: Maxime Thiebaut (@0xThiebaut)
    description: Detects access to a domain user from a non-machine account
    falsepositives:
    - Administrators configuring new users.
    level: medium
    references:
    - https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf
    - http://www.stuffithoughtiknew.com/2019/02/detecting-bloodhound.html
    - https://docs.microsoft.com/en-us/windows/win32/adschema/attributes-all
    tags:
    - attack.discovery
    - attack.t1087.002
  name: AD User Enumeration

