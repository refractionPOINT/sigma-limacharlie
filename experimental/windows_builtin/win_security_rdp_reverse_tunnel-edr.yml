detect:
  event: WEL
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: and
      rules:
      - case sensitive: false
        op: is
        path: event/EVENT/System/EventID
        value: '5156'
      - op: or
        rules:
        - op: and
          rules:
          - case sensitive: false
            op: is
            path: event/EVENT/EventData/SourcePort
            value: '3389'
          - op: or
            rules:
            - case sensitive: false
              op: starts with
              path: event/EVENT/EventData/DestAddress
              value: '127.'
            - case sensitive: false
              op: is
              path: event/EVENT/EventData/DestAddress
              value: ::1
        - op: and
          rules:
          - case sensitive: false
            op: is
            path: event/EVENT/EventData/DestPort
            value: '3389'
          - op: or
            rules:
            - case sensitive: false
              op: starts with
              path: event/EVENT/EventData/SourceAddress
              value: '127.'
            - case sensitive: false
              op: is
              path: event/EVENT/EventData/SourceAddress
              value: ::1
    - not: true
      op: or
      rules:
      - case sensitive: false
        op: is
        path: event/EVENT/EventData/FilterOrigin
        value: AppContainer Loopback
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/EVENT/EventData/Application
          value: \thor.exe
        - case sensitive: false
          op: ends with
          path: event/EVENT/EventData/Application
          value: \thor64.exe
respond:
- action: report
  metadata:
    author: Samir Bousseaden
    description: Detects svchost hosting RDP termsvcs communicating with the loopback
      address
    falsepositives:
    - Programs that connect locally to the RDP port
    level: high
    references:
    - https://twitter.com/SBousseaden/status/1096148422984384514
    - https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/44fbe85f72ee91582876b49678f9a26292a155fb/Command%20and%20Control/DE_RDP_Tunnel_5156.evtx
    tags:
    - attack.defense-evasion
    - attack.command-and-control
    - attack.lateral-movement
    - attack.t1090.001
    - attack.t1090.002
    - attack.t1021.001
    - car.2013-07-002
  name: RDP over Reverse SSH Tunnel WFP

