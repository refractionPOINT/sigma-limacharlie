detect:
  log type: wel
  op: and
  rules:
  - case sensitive: false
    op: is
    path: Event/System/EventID
    value: '5145'
  - case sensitive: false
    op: matches
    path: Event/EventData/ShareName
    re: \\\\\*\\\\IPC\$
  - case sensitive: false
    op: is
    path: Event/EventData/RelativeTargetName
    value: spoolss
  target: log
respond:
- action: report
  metadata:
    author: OTR (Open Threat Research)
    description: Detects the use of the spoolss named pipe over SMB. This can be used
      to trigger the authentication via NTLM of any machine that has the spoolservice
      enabled.
    falsepositives:
    - Domain Controllers acting as printer servers too? :)
    level: medium
    references:
    - https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1
    - https://dirkjanm.io/a-different-way-of-abusing-zerologon/
    - https://twitter.com/_dirkjan/status/1309214379003588608
    tags:
    - attack.lateral-movement
    - attack.t1021.002
  name: DCERPC SMB Spoolss Named Pipe

