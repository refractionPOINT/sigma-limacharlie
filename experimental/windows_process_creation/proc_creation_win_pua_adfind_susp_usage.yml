detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: domainlist
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: trustdmp
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: dcmodes
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: adinfo
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: ' dclist '
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: computer_pwdnotreqd
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: objectcategory=
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: -subnets -f
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: name="Domain Admins"
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: '-sc u:'
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: domainncs
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: dompol
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: ' oudmp '
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: subnetdmp
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: gpodmp
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: fspdmp
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: users_noexpire
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: computers_active
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: computers_pwdnotreqd
respond:
- action: report
  metadata:
    author: Janantha Marasinghe (https://github.com/blueteam0ps), FPT.EagleEye Team,
      omkar72, oscd.community
    description: Detects AdFind execution with common flags seen used during attacks
    falsepositives:
    - Legitimate admin activity
    level: high
    references:
    - https://www.joeware.net/freetools/tools/adfind/
    - https://thedfirreport.com/2020/05/08/adfind-recon/
    - https://thedfirreport.com/2021/01/11/trickbot-still-alive-and-well/
    - https://www.microsoft.com/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/
    - https://social.technet.microsoft.com/wiki/contents/articles/7535.adfind-command-examples.aspx
    - https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/bf62ece1c679b07b5fb49c4bae947fe24c81811f/fin6/Emulation_Plan/Phase1.md
    - https://github.com/redcanaryco/atomic-red-team/blob/0f229c0e42bfe7ca736a14023836d65baa941ed2/atomics/T1087.002/T1087.002.md#atomic-test-7---adfind---enumerate-active-directory-user-objects
    tags:
    - attack.discovery
    - attack.t1018
    - attack.t1087.002
    - attack.t1482
    - attack.t1069.002
    - stp.1u
  name: PUA - AdFind Suspicious Execution

