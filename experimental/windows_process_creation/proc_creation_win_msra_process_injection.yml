detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - case sensitive: false
      op: ends with
      path: event/PARENT/FILE_PATH
      value: \msra.exe
    - case sensitive: false
      op: ends with
      path: event/PARENT/COMMAND_LINE
      value: msra.exe
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \arp.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \cmd.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \net.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \netstat.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \nslookup.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \route.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \schtasks.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \whoami.exe
respond:
- action: report
  metadata:
    author: Alexander McDonald
    description: Detects potential process injection via Microsoft Remote Asssistance
      (Msra.exe) by looking at suspicious child processes spawned from the aforementioned
      process. It has been a target used by many threat actors and used for discovery
      and persistence tactics
    falsepositives:
    - Legitimate use of Msra.exe
    level: high
    references:
    - https://www.microsoft.com/security/blog/2021/12/09/a-closer-look-at-qakbots-latest-building-blocks-and-how-to-knock-them-down/
    - https://www.fortinet.com/content/dam/fortinet/assets/analyst-reports/ar-qakbot.pdf
    tags:
    - attack.defense_evasion
    - attack.t1055
  name: Potential Process Injection Via Msra.EXE

