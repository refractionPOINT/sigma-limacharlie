detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \reg.exe
    - op: and
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: 'add '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SYSTEM\CurrentControlSet\Services\
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' ImagePath '
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' -d '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' /d '
respond:
- action: report
  metadata:
    author: frack113
    description: 'Adversaries may execute their own malicious payloads by hijacking
      the Registry entries used by services.

      Adversaries may use flaws in the permissions for registry to redirect from the
      originally specified executable to one that they control, in order to launch
      their own code at Service start.

      Windows stores local service configuration information in the Registry under
      HKLM\SYSTEM\CurrentControlSet\Services

      '
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1574.011/T1574.011.md#atomic-test-2---service-imagepath-change-with-regexe
    tags:
    - attack.persistence
    - attack.t1574.011
  name: Changing Existing Service ImagePath Value Via Reg.EXE

