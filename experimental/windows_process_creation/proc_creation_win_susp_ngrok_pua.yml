detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' tcp 139'
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' tcp 445'
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' tcp 3389'
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' tcp 5985'
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' tcp 5986'
    - op: and
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: ' start '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: --all
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: --config
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: .yml
    - op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: ngrok.exe
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' tcp '
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' http '
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' authtoken '
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: '.exe authtoken '
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: .exe start --all
respond:
- action: report
  metadata:
    author: Florian Roth
    description: 'Detects the use of Ngrok, a utility used for port forwarding and
      tunneling, often used by threat actors to make local protected services publicly
      available.

      Involved domains are bin.equinox.io for download and *.ngrok.io for connections.

      '
    falsepositives:
    - Another tool that uses the command line switches of Ngrok
    - Ngrok http 3978 (https://docs.microsoft.com/en-us/azure/bot-service/bot-service-debug-channel-ngrok?view=azure-bot-service-4.0)
    level: high
    references:
    - https://ngrok.com/docs
    - https://www.fireeye.com/blog/threat-research/2021/05/shining-a-light-on-darkside-ransomware-operations.html
    - https://stackoverflow.com/questions/42442320/ssh-tunnel-to-ngrok-and-initiate-rdp
    - https://www.virustotal.com/gui/file/58d21840d915aaf4040ceb89522396124c82f325282f805d1085527e1e2ccfa1/detection
    - https://cybleinc.com/2021/02/15/ngrok-platform-abused-by-hackers-to-deliver-a-new-wave-of-phishing-attacks/
    - https://twitter.com/xorJosh/status/1598646907802451969
    - https://www.softwaretestinghelp.com/how-to-use-ngrok/
    tags:
    - attack.command_and_control
    - attack.t1572
  name: Ngrok Usage

