detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: PetitPotam
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: RottenPotato
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: HotPotato
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: JuicyPotato
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \just_dce_
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: Juicy Potato
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \temp\rot.exe
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \Potato.exe
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \SpoolSample.exe
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \Responder.exe
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \smbrelayx
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \ntlmrelayx
        - case sensitive: false
          op: contains
          path: event/FILE_PATH
          value: \LocalPotato
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: Invoke-Tater
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' smbrelay'
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' ntlmrelay'
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: 'cme smb '
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: ' /ntlm:NTLMhash '
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: Invoke-PetitPotam
        - case sensitive: false
          op: matches
          path: event/COMMAND_LINE
          re: .*\.exe\ \-t\ .*\ \-p\ .*
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: .exe -c "{
        - case sensitive: false
          op: ends with
          path: event/COMMAND_LINE
          value: '}" -z'
    - not: true
      op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/FILE_PATH
        value: HotPotatoes6
      - case sensitive: false
        op: contains
        path: event/FILE_PATH
        value: HotPotatoes7
      - case sensitive: false
        op: contains
        path: event/FILE_PATH
        value: 'HotPotatoes '
respond:
- action: report
  metadata:
    author: Florian Roth (Nextron Systems)
    description: Detects different hacktools used for relay attacks on Windows for
      privilege escalation
    falsepositives:
    - Legitimate files with these rare hacktool names
    level: critical
    references:
    - https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/
    - https://pentestlab.blog/2017/04/13/hot-potato/
    - https://github.com/ohpe/juicy-potato
    - https://hunter2.gitbook.io/darthsidious/other/war-stories/domain-admin-in-30-minutes
    - https://hunter2.gitbook.io/darthsidious/execution/responder-with-ntlm-relay-and-empire
    - https://www.localpotato.com/
    tags:
    - attack.execution
    - attack.credential-access
    - attack.t1557.001
  name: Potential SMB Relay Attack Tool Execution

