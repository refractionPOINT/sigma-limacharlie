detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \appcmd.exe
      - case sensitive: false
        op: is
        path: event/ORIGINAL_FILE_NAME
        value: appcmd.exe
    - op: and
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: set
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: config
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: section:system.webServer/rewrite/globalRules
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: 'commit:'
respond:
- action: report
  metadata:
    author: Nasreddine Bencherchali (Nextron Systems)
    description: Detects usage of "appcmd" to create new global URL rewrite rules.
      This behaviour has been observed being used by threat actors to add new rules
      so they can access their webshells.
    falsepositives:
    - Legitimate usage of appcmd to add new URL rewrite rules
    level: medium
    references:
    - https://twitter.com/malmoeb/status/1616702107242971144
    - https://learn.microsoft.com/en-us/answers/questions/739120/how-to-add-re-write-global-rule-with-action-type-r
    tags:
    - attack.defense-evasion
  name: Suspicious IIS URL GlobalRules Rewrite Via AppCmd

