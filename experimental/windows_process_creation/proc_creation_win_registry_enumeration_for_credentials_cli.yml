detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\Aerofox\Foxmail\V3.1
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\Aerofox\FoxmailPreview
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\DownloadManager\Passwords
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\FTPWare\COREFTP\Sites
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\IncrediMail\Identities
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\Martin Prikryl\WinSCP 2\Sessions
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\Mobatek\MobaXterm\
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\OpenSSH\Agent\Keys
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\OpenVPN-GUI\configs
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\ORL\WinVNC3\Password
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\Qualcomm\Eudora\CommandLine
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\RealVNC\WinVNC4
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\RimArts\B2\Settings
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\SimonTatham\PuTTY\Sessions
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\SimonTatham\PuTTY\SshHostKeys\
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\Sota\FFFTP
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\TightVNC\Server
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: \Software\WOW6432Node\Radmin\v3.0\Server\Parameters\Radmin
    - not: true
      op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: reg.exe
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: export
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: save
respond:
- action: report
  metadata:
    author: Nasreddine Bencherchali (Nextron Systems)
    description: Detects processes that query known 3rd party registry keys that holds
      credentials via commandline
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://isc.sans.edu/diary/More+Data+Exfiltration/25698
    - https://github.com/synacktiv/Radmin3-Password-Cracker/blob/acfc87393e4b7c06353973a14a6c7126a51f36ac/regkey.txt
    - https://github.com/HyperSine/how-does-MobaXterm-encrypt-password
    - https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#inside-the-registry
    tags:
    - attack.credential-access
    - attack.t1552.002
  name: Enumeration for 3rd Party Creds From CLI

