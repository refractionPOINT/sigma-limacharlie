detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \bitsadmin.exe
      - case sensitive: false
        op: is
        path: event/ORIGINAL_FILE_NAME
        value: bitsadmin.exe
    - op: or
      rules:
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: /SetNotifyCmdLine
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: '%COMSPEC%'
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: cmd.exe
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: regsvr32.exe
      - op: and
        rules:
        - case sensitive: false
          op: contains
          path: event/COMMAND_LINE
          value: /Addfile
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'http:'
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'https:'
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'ftp:'
          - case sensitive: false
            op: contains
            path: event/COMMAND_LINE
            value: 'ftps:'
respond:
- action: report
  metadata:
    author: Sreeman
    description: 'BITS will allow you to schedule a command to execute after a successful
      download to notify you that the job is finished.

      When the job runs on the system the command specified in the BITS job will be
      executed.

      This can be abused by actors to create a backdoor within the system and for
      persistence.

      It will be chained in a BITS job to schedule the download of malware/additional
      binaries and execute the program after being downloaded.

      '
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://www.fireeye.com/blog/threat-research/2020/10/kegtap-and-singlemalt-with-a-ransomware-chaser.html
    - http://0xthem.blogspot.com/2014/03/t-emporal-persistence-with-and-schtasks.html
    - https://isc.sans.edu/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Mechanism+-+Part+1/15394
    tags:
    - attack.defense-evasion
    - attack.t1197
  name: Monitoring For Persistence Via BITS

