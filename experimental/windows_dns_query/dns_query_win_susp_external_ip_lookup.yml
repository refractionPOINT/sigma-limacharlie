detect:
  event: DNS_REQUEST
  op: and
  rules:
  - op: or
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/DOMAIN_NAME
        value: ip.cn
      - case sensitive: false
        op: is
        path: event/DOMAIN_NAME
        value: l2.io
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: api.2ip.ua
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: api.bigdatacloud.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: api.ipify.org
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: bot.whatismyipaddress.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: canireachthe.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: checkip.amazonaws.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: checkip.dyndns.org
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: curlmyip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: db-ip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: edns.ip-api.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: eth0.me
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: freegeoip.app
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: geoipy.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: getip.pro
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: icanhazip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ident.me
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ifconfig.io
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ifconfig.me
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ip-api.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ip.360.cn
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ip.anysrc.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ip.taobao.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ip.tyk.nu
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipaddressworld.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipapi.co
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipconfig.io
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipecho.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipinfo.io
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipip.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipof.in
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipv4.icanhazip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipv4bot.whatismyipaddress.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipv6-test.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipwho.is
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: jsonip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: myexternalip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: seeip.org
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: wgetip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: whatismyip.akamai.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: whois.pconline.com.cn
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: wtfismyip.com
  - not: true
    op: or
    rules:
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \brave.exe
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files\Google\Chrome\Application\chrome.exe
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Google\Chrome\Application\chrome.exe
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files\Mozilla Firefox\firefox.exe
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Mozilla Firefox\firefox.exe
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Internet Explorer\iexplore.exe
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files\Internet Explorer\iexplore.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \maxthon.exe
    - op: or
      rules:
      - case sensitive: false
        op: starts with
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Microsoft\EdgeWebView\Application\
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \WindowsApps\MicrosoftEdge.exe
      - op: or
        rules:
        - case sensitive: false
          op: is
          path: event/FILE_PATH
          value: C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe
        - case sensitive: false
          op: is
          path: event/FILE_PATH
          value: C:\Program Files\Microsoft\Edge\Application\msedge.exe
    - op: and
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: starts with
          path: event/FILE_PATH
          value: C:\Program Files (x86)\Microsoft\EdgeCore\
        - case sensitive: false
          op: starts with
          path: event/FILE_PATH
          value: C:\Program Files\Microsoft\EdgeCore\
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \msedge.exe
        - case sensitive: false
          op: ends with
          path: event/FILE_PATH
          value: \msedgewebview2.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \opera.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \safari.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \seamonkey.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \vivaldi.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \whale.exe
respond:
- action: report
  metadata:
    author: Brandon George (blog post), Thomas Patzke
    description: Detects DNS queries for IP lookup services such as "api.ipify.org"
      originating from a non browser process.
    falsepositives:
    - Legitimate usage of IP lookup services such as ipify API
    level: medium
    references:
    - https://www.binarydefense.com/analysis-of-hancitor-when-boring-begets-beacon
    - https://twitter.com/neonprimetime/status/1436376497980428318
    - https://www.trendmicro.com/en_us/research/23/e/managed-xdr-investigation-of-ducktail-in-trend-micro-vision-one.html
    tags:
    - attack.reconnaissance
    - attack.t1590
  name: Suspicious DNS Query for IP Lookup Service APIs

