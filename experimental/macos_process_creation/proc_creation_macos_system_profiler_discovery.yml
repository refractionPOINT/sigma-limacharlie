detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is mac
  - op: and
    rules:
    - op: or
      rules:
      - case sensitive: true
        op: ends with
        path: event/FILE_PATH
        value: /system_profiler
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: system_profiler
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SPApplicationsDataType
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SPHardwareDataType
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SPNetworkDataType
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: SPUSBDataType
respond:
- action: report
  metadata:
    author: Stephen Lincoln `@slincoln_aiq` (AttackIQ)
    description: 'Detects the execution of "system_profiler" with specific "Data Types"
      that have been seen being used by threat actors and malware. It provides system
      hardware and software configuration information.

      This process is primarily used for system information discovery. However, "system_profiler"
      can also be used to determine if virtualization software is being run for defense
      evasion purposes.

      '
    falsepositives:
    - Legitimate administrative activities
    level: medium
    references:
    - https://www.trendmicro.com/en_za/research/20/k/new-macos-backdoor-connected-to-oceanlotus-surfaces.html
    - https://www.sentinelone.com/wp-content/uploads/pdf-gen/1630910064/20-common-tools-techniques-used-by-macos-threat-actors-malware.pdf
    - https://ss64.com/mac/system_profiler.html
    - https://objective-see.org/blog/blog_0x62.html
    - https://www.welivesecurity.com/2019/04/09/oceanlotus-macos-malware-update/
    - https://gist.github.com/nasbench/9a1ba4bc7094ea1b47bc42bf172961af
    tags:
    - attack.discovery
    - attack.defense-evasion
    - attack.t1082
    - attack.t1497.001
  name: System Information Discovery Using System_Profiler

