detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is mac
  - op: and
    rules:
    - case sensitive: true
      op: ends with
      path: event/FILE_PATH
      value: /openssl
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: /Volumes/
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: enc
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: -base64
    - case sensitive: false
      op: contains
      path: event/COMMAND_LINE
      value: ' -d '
respond:
- action: report
  metadata:
    author: Tim Rauch (rule), Elastic (idea)
    description: Detects when a built-in utility is used to decode and decrypt a payload
      after a macOS disk image (DMG) is executed. Malware authors may attempt to evade
      detection and trick users into executing malicious code by encoding and encrypting
      their payload and placing it in a disk image file. This behavior is consistent
      with adware or malware families such as Bundlore and Shlayer.
    falsepositives:
    - Unknown
    level: medium
    references:
    - https://github.com/elastic/protections-artifacts/commit/746086721fd385d9f5c6647cada1788db4aea95f#diff-5d42c3d772e04f1e8d0eb60f5233bc79def1ea73105a2d8822f44164f77ef823
    tags:
    - attack.t1059
    - attack.t1204
    - attack.execution
    - attack.t1140
    - attack.defense_evasion
    - attack.s0482
    - attack.s0402
  name: Payload Decoded and Decrypted via Built-in Utilities

